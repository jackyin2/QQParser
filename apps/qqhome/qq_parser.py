# f = open("./qq_cont/jl2.txt", 'r',encoding='utf-8', errors='ignore')# -*- coding: utf-8 -*-import reimport codecsfrom openpyxl import Workbookfrom openpyxl import load_workbook# from openpyxl.writer.excel import ExcelWriterimport pymysqlimport timedef openfile(file):    '''    打开文件    :param file:     :return:     '''    f = codecs.open(file, 'r', encoding='utf-8')    # content = f.readline()    return fdef qq_parser(f, pattern):    '''    分析QQ记录    :param f:     :param pattern:     :return:     '''    list_contents = []    i = 0    for (num, value) in enumerate(f):        dict1 = {            'num': '',            'date': '',            'user': '',            'content': ''        }        data = pattern.search(value)        if data:            print('正在执行', i, )            j = 1            date = data.group()            dict1['num'] = num            dict1['date'] = date            dict1['user'] = value[len(date) + 1:]            dict1['content'] = ''            list_contents.append(dict1)        else:            # print(i, j)            list_contents[-1]['content'] = list_contents[-1]['content'] + value            j += 1        i += 1    print('*******************************总共执行', i, '个**************************************************')    return list_contentsdef write_to_mysql(values):    '''        写入到mysql数据库中    :param values:     :return:     '''    db = pymysql.connect(host='localhost', user='root',                         password='root', db='test', port=3306, charset='utf8mb4')    cur = db.cursor()    for i in range(len(values)):        num = values[i]['num']        user = values[i]['user']        content = str(values[i]['content']).replace("===", '')        # content = str(values[i]['content'])        # date = values[i]['date']        date = values[i]['date'].encode('utf-8').decode('utf-8-sig')        # addtime = time.strftime("%Y-%m-%d", time.localtime(int(time.time())))        key_values = (num, user, content, date)        try:            sql_insert = '''insert into qqhome_qqcontent(num,qqname,content,qqdate) values(%s, %s, %s, %s)'''            # sql_insert2 = '''insert into qq_contents(num,user,content,date) values(?,?,?,?)'''            cur.execute(sql_insert, key_values)            # 提交            # db.commit()            print('插入成功第', i , '个')        except Exception as e:            raise e            # 错误回滚            db.rollback()    db.commit()    db.close()    print('#####################总共插入数据库', i, '个############################')    return Truedef col_str2int(letter):    """        :introduce        将 excel 中的 列 str 转换为 int 数字        :param        letter:    """    if 64 <= ord(letter) <= 96:        return int(ord(letter)) - 65    elif 97 <= ord(letter) <= 122:        return int(ord(letter)) - 97def write_to_execl(values, execl_path):    '''    写入内容到execl表格中    :param values:     :param execl_path:     :return:     '''    # workbook_ = load_workbook(execl_path)    wb =  load_workbook(execl_path)    # wb = Workbook()    sheet_0 = wb.active    tableTitle = ['Num', 'User', 'Date', 'Content']    # 维护表头    for col in range(len(tableTitle)):        c = col + 1        # print(sheet_0.cell(row=1, column=c).value)        sheet_0.cell(row=1, column=c).value = tableTitle[col]        # print(sheet_0.cell(row=1, column=c).value)    # 数据表基本信息    for i in range(len(values)):        print('开始插入第',i+1,'个')        sheet_0.cell(row=i + 2, column=1).value = str(values[i]['num'])        sheet_0.cell(row=i + 2, column=2).value = values[i]['user']        sheet_0.cell(row=i + 2, column=3).value = values[i]['date']        sheet_0.cell(row=i + 2, column=4).value = values[i]['content']        print('结束插入第' , i+1 , '个')    wb.save(filename=execl_path)    print('写入结束','总共写入',i+1,'个')    return Trueif __name__ == '__main__':    file = r'./qq_cont/0523.txt'    execl_path = r'./qq_cont/QQ_.xlsx'    HMS_pattern = re.compile('(.*?\d{4}-\d{1,2}-\d{1,2}\s\d{1,2}:\d{1,2}:\d{1,2})', re.S)    f = openfile(file)    #    values = qq_parser(f, HMS_pattern)    # values = [{'num': 0, 'date':'11111', 'user':'abc', 'content': 'aaaacontent'}]    # write_to_execl(values, execl_path)    write_to_mysql(values)